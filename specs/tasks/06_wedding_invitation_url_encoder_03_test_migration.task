# Task: Test Database Migration

**Task ID:** `06_wedding_invitation_url_encoder_03_test_migration`  
**Plan:** `06_wedding_invitation_url_encoder.plan`  
**Phase:** Phase 1 - Database Design  
**Status:** üìù Todo  
**Created:** 2025-11-12  
**Last Updated:** 2025-11-12

---

## üìã Task Overview

**Title:** Test Migration UP/DOWN and Verify Database Ready  
**Priority:** üî¥ Critical  
**Estimate:** 1 hour  
**Actual Time:** -

**Description:**  
Th·ª±c thi migration scripts trong development environment v√† verify table, indexes, trigger ƒë·ªÅu ho·∫°t ƒë·ªông ch√≠nh x√°c. Test c·∫£ UP v√† DOWN migrations ƒë·ªÉ ƒë·∫£m b·∫£o rollback capability. Sau khi test pass, database s·∫Ω s·∫µn s√†ng cho Phase 2 (Backend API).

**Assigned To:** Backend Developer  
**Due Date:** Day 1 (Phase 1)

---

## üéØ Objectives

1. **Primary Objective**
   - Run migration UP successfully in development database
   - Verify table structure, indexes, trigger, foreign key
   - Test migration DOWN (rollback)
   - Re-run migration UP ƒë·ªÉ database s·∫µn s√†ng cho development

2. **Secondary Objectives**
   - Document migration process
   - Test insert/update/delete operations
   - Verify soft delete pattern works
   - Check CASCADE DELETE behavior

---

## ‚úÖ Acceptance Criteria

- [ ] Migration UP runs without errors
  - Table `wedding_urls` created
  - All 6 columns present v·ªõi correct data types
  - 2 indexes created (user_id, deleted_at)
  - Trigger created and functional
  - Foreign key constraint active

- [ ] Database verification complete:
  - `\d wedding_urls` shows correct structure
  - `\di` shows both indexes
  - `\dt` shows trigger
  - INSERT, UPDATE, DELETE operations work
  - Trigger auto-updates `updated_at`
  - CASCADE DELETE removes wedding_urls when user deleted

- [ ] Migration DOWN tested:
  - Rollback runs without errors
  - Table and trigger dropped completely
  - Can safely re-run UP migration

- [ ] Database ready for Phase 2:
  - Final state: migration UP applied
  - No data in wedding_urls (clean state)
  - Ready for API development

---

## üìù Subtasks

### Pre-Migration Setup
- [ ] **Subtask 3.1:** Verify database connection
  ```bash
  psql $DATABASE_URL -c "SELECT version();"
  ```
  - Confirm PostgreSQL version >= 13
  - Verify connection successful
  
- [ ] **Subtask 3.2:** Check prerequisites
  ```sql
  -- Verify uuid-ossp extension
  SELECT * FROM pg_extension WHERE extname = 'uuid-ossp';
  
  -- Verify users table exists
  \dt users
  
  -- Verify update_updated_at_column() function exists
  SELECT proname FROM pg_proc WHERE proname = 'update_updated_at_column';
  ```

- [ ] **Subtask 3.3:** Backup current database (safety)
  ```bash
  pg_dump $DATABASE_URL > backup_before_migration_007.sql
  ```

### Migration UP Testing
- [ ] **Subtask 3.4:** Run migration UP
  ```bash
  psql $DATABASE_URL -f backend/database/migrations/007_up_wedding_urls.sql
  ```
  - Check for success message
  - No errors in output

- [ ] **Subtask 3.5:** Verify table structure
  ```bash
  psql $DATABASE_URL -c "\d wedding_urls"
  ```
  Expected output:
  ```
  Column      | Type         | Collation | Nullable | Default
  ------------+--------------+-----------+----------+------------------------
  id          | uuid         |           | not null | uuid_generate_v4()
  user_id     | uuid         |           | not null |
  base_url    | varchar(500) |           | not null |
  created_at  | timestamp    |           | not null | now()
  updated_at  | timestamp    |           | not null | now()
  deleted_at  | timestamp    |           |          |
  
  Indexes:
    "wedding_urls_pkey" PRIMARY KEY, btree (id)
    "idx_wedding_urls_user_id" btree (user_id)
    "idx_wedding_urls_deleted_at" btree (deleted_at)
  
  Foreign-key constraints:
    "wedding_urls_user_id_fkey" FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
  
  Triggers:
    update_wedding_urls_updated_at BEFORE UPDATE ON wedding_urls FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()
  ```

- [ ] **Subtask 3.6:** Verify indexes created
  ```bash
  psql $DATABASE_URL -c "SELECT indexname, indexdef FROM pg_indexes WHERE tablename = 'wedding_urls';"
  ```
  Should return:
  - wedding_urls_pkey
  - idx_wedding_urls_user_id
  - idx_wedding_urls_deleted_at

### Functional Testing
- [ ] **Subtask 3.7:** Test INSERT operation
  ```sql
  -- Get a real user_id from users table
  SELECT id FROM users LIMIT 1;
  
  -- Insert test row
  INSERT INTO wedding_urls (user_id, base_url) 
  VALUES ('user-uuid-here', 'https://test.invitations.com/test');
  
  -- Verify inserted
  SELECT * FROM wedding_urls WHERE base_url LIKE '%test%';
  ```
  Expected: 1 row returned with auto-generated id, timestamps

- [ ] **Subtask 3.8:** Test trigger (updated_at auto-update)
  ```sql
  -- Get current updated_at
  SELECT id, base_url, updated_at FROM wedding_urls WHERE base_url LIKE '%test%';
  
  -- Wait 2 seconds
  SELECT pg_sleep(2);
  
  -- Update base_url
  UPDATE wedding_urls SET base_url = 'https://test.invitations.com/test-updated' 
  WHERE base_url LIKE '%test%';
  
  -- Verify updated_at changed
  SELECT id, base_url, updated_at FROM wedding_urls WHERE base_url LIKE '%test-updated%';
  ```
  Expected: updated_at timestamp is 2+ seconds newer

- [ ] **Subtask 3.9:** Test soft delete pattern
  ```sql
  -- Soft delete (set deleted_at)
  UPDATE wedding_urls SET deleted_at = NOW() WHERE base_url LIKE '%test-updated%';
  
  -- Query active records only
  SELECT * FROM wedding_urls WHERE deleted_at IS NULL;
  ```
  Expected: Test record not in results (soft deleted)
  
  ```sql
  -- Query deleted records
  SELECT * FROM wedding_urls WHERE deleted_at IS NOT NULL;
  ```
  Expected: Test record appears (soft deleted but still in DB)

- [ ] **Subtask 3.10:** Test CASCADE DELETE
  ```sql
  -- Create test user
  INSERT INTO users (id, email, name) 
  VALUES (uuid_generate_v4(), 'test@example.com', 'Test User') 
  RETURNING id;
  -- Note the returned user_id
  
  -- Create wedding_url for test user
  INSERT INTO wedding_urls (user_id, base_url) 
  VALUES ('test-user-id-here', 'https://cascade.test.com');
  
  -- Verify wedding_url exists
  SELECT COUNT(*) FROM wedding_urls WHERE user_id = 'test-user-id-here';
  -- Expected: 1
  
  -- Delete user (should CASCADE to wedding_urls)
  DELETE FROM users WHERE id = 'test-user-id-here';
  
  -- Verify wedding_url auto-deleted
  SELECT COUNT(*) FROM wedding_urls WHERE user_id = 'test-user-id-here';
  -- Expected: 0 (CASCADE DELETE worked)
  ```

### Migration DOWN Testing
- [ ] **Subtask 3.11:** Clean up test data
  ```sql
  DELETE FROM wedding_urls WHERE base_url LIKE '%test%';
  ```

- [ ] **Subtask 3.12:** Run migration DOWN
  ```bash
  psql $DATABASE_URL -f backend/database/migrations/007_down_wedding_urls.sql
  ```
  - Check for success message
  - No errors in output

- [ ] **Subtask 3.13:** Verify table dropped
  ```bash
  psql $DATABASE_URL -c "\dt wedding_urls"
  ```
  Expected: "Did not find any relation named 'wedding_urls'"

- [ ] **Subtask 3.14:** Verify trigger dropped
  ```bash
  psql $DATABASE_URL -c "SELECT tgname FROM pg_trigger WHERE tgrelid = 'wedding_urls'::regclass;"
  ```
  Expected: Error (table doesn't exist) or 0 rows

### Final Setup for Development
- [ ] **Subtask 3.15:** Re-run migration UP
  ```bash
  psql $DATABASE_URL -f backend/database/migrations/007_up_wedding_urls.sql
  ```
  - Verify successful
  - Database now ready for Phase 2

- [ ] **Subtask 3.16:** Verify clean state
  ```sql
  SELECT COUNT(*) FROM wedding_urls;
  ```
  Expected: 0 (empty table ready for development)

- [ ] **Subtask 3.17:** Update migration log
  - File: `backend/database/MIGRATION_LOG.md` (if exists)
  - Add entry: Migration 007 completed on [date]

---

## üìÇ Files to Verify/Update

### Existing Files to Check
```
backend/database/migrations/007_up_wedding_urls.sql    - Must exist (Task 02)
backend/database/migrations/007_down_wedding_urls.sql  - Must exist (Task 02)
```

### Files to Update (Optional)
```
backend/database/MIGRATION_LOG.md  - Add migration 007 entry
docs/database/wedding_urls_schema.md - Confirm schema matches actual table
```

---

## üß™ Testing Plan

### Automated Test Script

Create `backend/database/migrations/test_007_migration.sh`:
```bash
#!/bin/bash
set -e  # Exit on error

echo "=== Testing Migration 007: wedding_urls ==="

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

test_passed() {
  echo -e "${GREEN}‚úì $1${NC}"
}

test_failed() {
  echo -e "${RED}‚úó $1${NC}"
  exit 1
}

# 1. Run migration UP
echo "Step 1: Running migration UP..."
psql $DATABASE_URL -f backend/database/migrations/007_up_wedding_urls.sql > /dev/null 2>&1
if [ $? -eq 0 ]; then
  test_passed "Migration UP successful"
else
  test_failed "Migration UP failed"
fi

# 2. Check table exists
echo "Step 2: Checking table exists..."
TABLE_EXISTS=$(psql $DATABASE_URL -tAc "SELECT to_regclass('wedding_urls')")
if [ "$TABLE_EXISTS" = "wedding_urls" ]; then
  test_passed "Table 'wedding_urls' exists"
else
  test_failed "Table 'wedding_urls' not found"
fi

# 3. Check column count
echo "Step 3: Checking columns..."
COL_COUNT=$(psql $DATABASE_URL -tAc "SELECT COUNT(*) FROM information_schema.columns WHERE table_name = 'wedding_urls'")
if [ "$COL_COUNT" -eq 6 ]; then
  test_passed "All 6 columns present"
else
  test_failed "Expected 6 columns, found $COL_COUNT"
fi

# 4. Check indexes
echo "Step 4: Checking indexes..."
INDEX_COUNT=$(psql $DATABASE_URL -tAc "SELECT COUNT(*) FROM pg_indexes WHERE tablename = 'wedding_urls'")
if [ "$INDEX_COUNT" -ge 3 ]; then  # Primary key + 2 custom indexes
  test_passed "Indexes created (found $INDEX_COUNT)"
else
  test_failed "Expected at least 3 indexes, found $INDEX_COUNT"
fi

# 5. Check trigger
echo "Step 5: Checking trigger..."
TRIGGER_EXISTS=$(psql $DATABASE_URL -tAc "SELECT COUNT(*) FROM pg_trigger WHERE tgrelid = 'wedding_urls'::regclass AND tgname = 'update_wedding_urls_updated_at'")
if [ "$TRIGGER_EXISTS" -eq 1 ]; then
  test_passed "Trigger 'update_wedding_urls_updated_at' exists"
else
  test_failed "Trigger not found"
fi

# 6. Test INSERT
echo "Step 6: Testing INSERT..."
USER_ID=$(psql $DATABASE_URL -tAc "SELECT id FROM users LIMIT 1")
if [ -z "$USER_ID" ]; then
  test_failed "No users found in database (needed for FK test)"
fi

INSERT_RESULT=$(psql $DATABASE_URL -tAc "INSERT INTO wedding_urls (user_id, base_url) VALUES ('$USER_ID', 'https://test-migration.com') RETURNING id")
if [ ! -z "$INSERT_RESULT" ]; then
  test_passed "INSERT successful (id: $INSERT_RESULT)"
else
  test_failed "INSERT failed"
fi

# 7. Test trigger (updated_at)
echo "Step 7: Testing trigger..."
sleep 1
UPDATE_RESULT=$(psql $DATABASE_URL -tAc "UPDATE wedding_urls SET base_url = 'https://test-migration-updated.com' WHERE id = '$INSERT_RESULT' RETURNING updated_at > created_at")
if [ "$UPDATE_RESULT" = "t" ]; then
  test_passed "Trigger working (updated_at > created_at)"
else
  test_failed "Trigger not working"
fi

# 8. Clean up test data
echo "Step 8: Cleaning up test data..."
psql $DATABASE_URL -tAc "DELETE FROM wedding_urls WHERE id = '$INSERT_RESULT'" > /dev/null
test_passed "Test data cleaned"

# 9. Run migration DOWN
echo "Step 9: Running migration DOWN..."
psql $DATABASE_URL -f backend/database/migrations/007_down_wedding_urls.sql > /dev/null 2>&1
if [ $? -eq 0 ]; then
  test_passed "Migration DOWN successful"
else
  test_failed "Migration DOWN failed"
fi

# 10. Verify table dropped
echo "Step 10: Verifying table dropped..."
TABLE_EXISTS=$(psql $DATABASE_URL -tAc "SELECT to_regclass('wedding_urls')")
if [ -z "$TABLE_EXISTS" ] || [ "$TABLE_EXISTS" = "" ]; then
  test_passed "Table dropped successfully"
else
  test_failed "Table still exists after DOWN migration"
fi

# 11. Re-run migration UP for development
echo "Step 11: Re-running migration UP for development..."
psql $DATABASE_URL -f backend/database/migrations/007_up_wedding_urls.sql > /dev/null 2>&1
if [ $? -eq 0 ]; then
  test_passed "Migration UP re-applied"
else
  test_failed "Failed to re-apply migration UP"
fi

echo ""
echo -e "${GREEN}=== All tests passed! Database ready for Phase 2 ===${NC}"
```

### Run Test Script
```bash
chmod +x backend/database/migrations/test_007_migration.sh
./backend/database/migrations/test_007_migration.sh
```

---

## üîó Dependencies

### Blocking Dependencies
- [ ] Task 02: Migration scripts written and syntax-validated
- [ ] Database connection configured in .env
- [ ] PostgreSQL running and accessible
- [ ] At least 1 user in users table (for FK test)

### Related Tasks
- Phase 2 Task 2.1: Backend controller (depends on this database)
- Phase 2 Task 2.2: API routes (depends on this database)

---

## üêõ Known Issues

### Issue 1: No users in database
**Severity:** üü† High  
**Workaround:** Create test user:
```sql
INSERT INTO users (email, name, password_hash) 
VALUES ('test@test.com', 'Test User', 'hashed_password');
```
**Resolution:** Ensure users table is seeded in development

### Issue 2: uuid-ossp extension not enabled
**Severity:** üî¥ Critical  
**Error:** `function uuid_generate_v4() does not exist`  
**Resolution:** Run:
```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

### Issue 3: update_updated_at_column() function missing
**Severity:** üî¥ Critical  
**Error:** `function update_updated_at_column() does not exist`  
**Resolution:** Create function or verify init migration ran:
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## üìù Notes

### Testing Best Practices
- **Test in isolation:** Use test database if possible
- **Backup first:** Always pg_dump before migration
- **Verify thoroughly:** Don't skip verification steps
- **Test rollback:** Always test DOWN migration
- **Document issues:** Note any errors for team

### Common PostgreSQL Commands
```bash
# Connect to database
psql $DATABASE_URL

# List tables
\dt

# Describe table
\d wedding_urls

# List indexes
\di

# List triggers
SELECT tgname FROM pg_trigger WHERE tgrelid = 'wedding_urls'::regclass;

# Check table size
SELECT pg_size_pretty(pg_total_relation_size('wedding_urls'));

# Count rows
SELECT COUNT(*) FROM wedding_urls;
```

### Performance Check
After migration, check query performance:
```sql
-- Enable query timing
\timing on

-- Test index usage on user_id
EXPLAIN ANALYZE 
SELECT * FROM wedding_urls WHERE user_id = 'some-uuid' AND deleted_at IS NULL;
-- Should show "Index Scan using idx_wedding_urls_user_id"

-- Test index usage on deleted_at
EXPLAIN ANALYZE 
SELECT * FROM wedding_urls WHERE deleted_at IS NULL;
-- Should show "Index Scan using idx_wedding_urls_deleted_at" or "Bitmap Index Scan"
```

---

## ‚úÖ Checklist Before Marking Done

### Pre-Migration
- [ ] Database backup created
- [ ] Prerequisites verified (extensions, users table)
- [ ] Migration scripts reviewed

### Testing
- [ ] Migration UP runs successfully
- [ ] Table structure verified (6 columns)
- [ ] Indexes verified (2 custom indexes)
- [ ] Trigger verified and functional
- [ ] Foreign key verified (CASCADE DELETE)
- [ ] INSERT operation tested
- [ ] UPDATE operation tested (trigger works)
- [ ] Soft delete pattern tested
- [ ] CASCADE DELETE tested
- [ ] Migration DOWN runs successfully
- [ ] Table dropped completely
- [ ] Migration UP re-applied
- [ ] Database in clean state (0 rows)

### Documentation
- [ ] Migration log updated
- [ ] Issues documented (if any)
- [ ] Test results recorded

### Sign-off
- [ ] Database ready for Phase 2
- [ ] Team notified migration complete
- [ ] Backup retained for safety

---

## üîÑ Progress Log

### 2025-11-12 - Created
- Task created from Phase 1 of implementation plan
- Ready to test migration scripts

---

## üéØ Deliverables

- [ ] Migration tested successfully in development
- [ ] Database verified and ready:
  - Table `wedding_urls` exists
  - Indexes functional
  - Trigger working
  - Foreign key enforced
  - Soft delete pattern operational
  - CASCADE DELETE working
- [ ] Rollback tested (DOWN migration works)
- [ ] Documentation updated
- [ ] **Phase 1 COMPLETE** - Ready for Phase 2

**Completed By:** -  
**Completion Date:** -  
**Time Taken:** - hours

---

**Next Phase:** Phase 2 - Backend API Development  
**Next Task:** `06_wedding_invitation_url_encoder_04_backend_controller`  
**Related Plan:** `plans/06_wedding_invitation_url_encoder.plan`  
**Related Spec:** `specs/06_wedding_invitation_url_encoder.spec`
